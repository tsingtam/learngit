/**
 * @include "../mx.js"
 * @include "../utils/mx.News.js"
 * @include "../utils/mx.Time.js"
    {"file":null,"files":[{"fileName":"1424075258526.jpg","fileUrl":"file:/storage/emulated/0/DCIM/Camera/1424075258526.jpg","fileType":"photo","params":{"id":"0","type":"car","tag":"车尾","position":"39.977034,116.310152","address":"中国北京市海淀区海淀南路11号楼","userkey":"8d67895a3e71d067f57632f26ae4ce9d","phoneid":"891bc32420410359"},"mimeType":"image/jpeg","uploadTime":"2015-02-16 17:24","fail":1},{"fileName":"1424075203318.jpg","fileUrl":"file:/storage/emulated/0/DCIM/Camera/1424075203318.jpg","fileType":"photo","params":{"id":"0","type":"house","tag":"房子近景","position":"39.977034,116.310152","address":"中国北京市海淀区海淀南路11号楼","userkey":"8d67895a3e71d067f57632f26ae4ce9d","phoneid":"891bc32420410359"},"mimeType":"image/jpeg","uploadTime":"2015-02-16 17:24","fail":1},{"fileName":"VID_20150216_172701.mp4","fileUrl":"file:/storage/emulated/0/DCIM/Camera/VID_20150216_172701.mp4","fileType":"video","params":{"id":"1","type":"house","tag":"房产证","position":"39.977034,116.310152","address":"","userkey":"56535c3684325dbdbf2689d13310f2f5","phoneid":"891bc32420410359"},"mimeType":"video/mp4","uploadTime":"2015-02-16 17:44","fail":1},{"fileName":"2月16日 17点27分.mp3","fileUrl":"file:/storage/emulated/0/MIUI/sound_recorder/2月16日%2017点27分.mp3","fileType":"audio","params":{"id":"1","type":"car","tag":"车尾","position":"39.977034,116.310152","address":"","userkey":"56535c3684325dbdbf2689d13310f2f5","phoneid":"891bc32420410359"},"mimeType":"audio/mpeg","uploadTime":"2015-02-16 17:44","fail":1},{"fileName":"2月16日 17点26分.mp3","fileUrl":"file:/storage/emulated/0/MIUI/sound_recorder/2月16日%2017点26分.mp3","fileType":"audio","params":{"id":"1","type":"house","tag":"房子近景","position":"39.977034,116.310152","address":"中国北京市海淀区海淀南路11号楼","userkey":"56535c3684325dbdbf2689d13310f2f5","phoneid":"891bc32420410359"},"mimeType":"audio/mpeg","uploadTime":"2015-02-16 17:44","fail":1},{"fileName":"VID_20150216_172725.mp4","fileUrl":"file:/storage/emulated/0/DCIM/Camera/VID_20150216_172725.mp4","fileType":"video","params":{"id":"1","type":"car","tag":"车头","position":"39.977034,116.310152","address":"","userkey":"56535c3684325dbdbf2689d13310f2f5","phoneid":"891bc32420410359"},"mimeType":"video/mp4","uploadTime":"2015-02-16 17:44","fail":1}],"filesUploaded":[{"fileName":"2月12日 07点12分.mp3","fileUrl":"file:/storage/emulated/0/MIUI/sound_recorder/2月12日%2007点12分.mp3","fileType":"audio","params":{"id":"208","type":"corp","tag":"人厂合影","userkey":"56535c3684325dbdbf2689d13310f2f5","phoneid":"891bc32420410359"},"mimeType":"audio/mpeg","uploadTime":"2015-02-16 17:44"},{"fileName":"VID_20150212_071248.mp4","fileUrl":"file:/storage/emulated/0/DCIM/Camera/VID_20150212_071248.mp4","fileType":"video","params":{"id":"208","type":"corp","tag":"个人身份证","userkey":"56535c3684325dbdbf2689d13310f2f5","phoneid":"891bc32420410359"},"mimeType":"video/mp4","uploadTime":"2015-02-16 17:44"},{"fileName":"1424076509160.jpg","fileUrl":"file:/storage/emulated/0/DCIM/Camera/1424076509160.jpg","fileType":"photo","params":{"id":"451","type":"car","tag":"行驶本","position":"39.977034,116.310152","address":"","userkey":"8d67895a3e71d067f57632f26ae4ce9d","phoneid":"891bc32420410359"},"mimeType":"image/jpeg","uploadTime":"2015-02-16 17:24"},{"fileName":"1424076495185.jpg","fileUrl":"file:/storage/emulated/0/DCIM/Camera/1424076495185.jpg","fileType":"photo","params":{"id":"451","type":"house","tag":"发票","position":"39.977034,116.310152","address":"","userkey":"8d67895a3e71d067f57632f26ae4ce9d","phoneid":"891bc32420410359"},"mimeType":"image/jpeg","uploadTime":"2015-02-16 17:24"},{"fileName":"1423799201739.jpg","fileUrl":"file:/storage/emulated/0/DCIM/Camera/1423799201739.jpg","fileType":"photo","params":{"id":"208","type":"corp","tag":"厂房远景","position":"39.977008,116.310102","address":"中国北京市海淀区海淀南路11号楼","userkey":"86d2a115576198b0897dcc2a05921af6","phoneid":"891bc32420410359"},"mimeType":"image/jpeg","uploadTime":"2015-02-13 03:46"},{"fileName":"1423793966903.jpg","fileUrl":"file:/storage/emulated/0/DCIM/Camera/1423793966903.jpg","fileType":"photo","params":{"id":"208","type":"corp","tag":"法人代表证明书","userkey":"16bbe46bfd27d09cc94bdac3d4c91844","phoneid":"891bc32420410359"},"mimeType":"image/jpeg","uploadTime":"2015-02-13 02:19"},{"fileName":"1423734384772.jpg","fileUrl":"file:/storage/emulated/0/DCIM/Camera/1423734384772.jpg","fileType":"photo","params":{"id":"208","type":"corp","tag":"月均电费单","userkey":"94f366c7d0e7af9ca356e38c4182c071","phoneid":"891bc32420410359"},"mimeType":"image/jpeg","uploadTime":"2015-02-12 09:46"},{"fileName":"1423734327882.jpg","fileUrl":"file:/storage/emulated/0/DCIM/Camera/1423734327882.jpg","fileType":"photo","params":{"id":"208","type":"corp","tag":"法人代表证明书","userkey":"94f366c7d0e7af9ca356e38c4182c071","phoneid":"891bc32420410359"},"mimeType":"image/jpeg","uploadTime":"2015-02-12 09:45"},{"fileName":"1423730315200.jpg","fileUrl":"file:/storage/emulated/0/DCIM/Camera/1423730315200.jpg","fileType":"photo","params":{"id":"208","type":"corp","tag":"个人身份证","userkey":"f57bf1c99dcb1a9093a74fa0b7f5bc0e","phoneid":"891bc32420410359"},"mimeType":"image/jpeg","uploadTime":"2015-02-12 08:39"},{"fileName":"1423730165278.jpg","fileUrl":"file:/storage/emulated/0/DCIM/Camera/1423730165278.jpg","fileType":"photo","params":{"id":"208","type":"corp","tag":"法人代表证明书","userkey":"6966cf6a662f51c832ae68b9efac3592","phoneid":"891bc32420410359"},"mimeType":"image/jpeg","uploadTime":"2015-02-12 08:36"},{"fileName":"1423710965560.jpg","fileUrl":"file:/storage/emulated/0/DCIM/Camera/1423710965560.jpg","fileType":"photo","params":{"id":"208","type":"corp","tag":"购销合同","userkey":"daff3ceae36e58bb41d2663540aba6e8","phoneid":"891bc32420410359"},"mimeType":"image/jpeg","uploadTime":"2015-02-12 03:16"},{"fileName":"2月12日 03点16分.mp3","fileUrl":"file:/storage/emulated/0/MIUI/sound_recorder/2月12日%2003点16分.mp3","fileType":"audio","params":{"id":"208","type":"corp","tag":"月均电费单","userkey":"daff3ceae36e58bb41d2663540aba6e8","phoneid":"891bc32420410359"},"mimeType":"audio/mpeg","uploadTime":"2015-02-12 03:16"},{"fileName":"VID_20150212_031629.mp4","fileUrl":"file:/storage/emulated/0/DCIM/Camera/VID_20150212_031629.mp4","fileType":"video","params":{"id":"208","type":"corp","tag":"法人代表证明书","userkey":"daff3ceae36e58bb41d2663540aba6e8","phoneid":"891bc32420410359"},"mimeType":"video/mp4","uploadTime":"2015-02-12 03:16"},{"fileName":"1423711135369.jpg","fileUrl":"file:/storage/emulated/0/DCIM/Camera/1423711135369.jpg","fileType":"photo","params":{"id":"208","type":"corp","tag":"财务报表","userkey":"86903dc96bccf1fc9d6da2fc3423c89a","phoneid":"891bc32420410359"},"mimeType":"image/jpeg","uploadTime":"2015-02-12 03:27"},{"fileName":"VID_20150212_031908.mp4","fileUrl":"file:/storage/emulated/0/DCIM/Camera/VID_20150212_031908.mp4","fileType":"video","params":{"id":"208","type":"corp","tag":"店铺租赁证明","userkey":"86903dc96bccf1fc9d6da2fc3423c89a","phoneid":"891bc32420410359"},"mimeType":"video/mp4","uploadTime":"2015-02-12 03:28"},{"fileName":"2月12日 03点19分.mp3","fileUrl":"file:/storage/emulated/0/MIUI/sound_recorder/2月12日%2003点19分.mp3","fileType":"audio","params":{"id":"208","type":"corp","tag":"店铺租赁证明","userkey":"86903dc96bccf1fc9d6da2fc3423c89a","phoneid":"891bc32420410359"},"mimeType":"audio/mpeg","uploadTime":"2015-02-12 03:28"},{"fileName":"1423725147246.jpg","fileUrl":"file:/storage/emulated/0/DCIM/Camera/1423725147246.jpg","fileType":"photo","params":{"id":"208","type":"corp","tag":"个人身份证","userkey":"cfd1dda2b16ab009b7466d2fd095d361","phoneid":"891bc32420410359"},"mimeType":"image/jpeg","uploadTime":"2015-02-12 07:54"},{"fileName":"1423728140675.jpg","fileUrl":"file:/storage/emulated/0/DCIM/Camera/1423728140675.jpg","fileType":"photo","params":{"id":"208","type":"corp","tag":"月均电费单","userkey":"8d0136ad0e79c9de96b92c2ef1aadb3e","phoneid":"891bc32420410359"},"mimeType":"image/jpeg","uploadTime":"2015-02-12 08:33"},{"fileName":"1423730091833.jpg","fileUrl":"file:/storage/emulated/0/DCIM/Camera/1423730091833.jpg","fileType":"photo","params":{"id":"208","type":"corp","tag":"法人代表证明书","userkey":"6114ab00df6f1fb9a1bcb3e1d365ac22","phoneid":"891bc32420410359"},"mimeType":"image/jpeg","uploadTime":"2015-02-12 08:35"}]}
 */
define('utils/chat', ['lib/jquery', 'lib/ux'], function(require, exports) {
	'use strict';
	require('lib/ux');
	var $ = require('lib/jquery'),
		Page = require('module/Page'),
		addReduce = require('utils/addReduce'),
		tips = require('utils/tips');
	if (window.config && window.config.imServer) {
		var webim = {
			'server': 'ws://' + config.imServer + ':9514' //线上
		};
	} else {
		var webim = {
			'server': 'ws://www.lvdaniu.com:9514' //线上
		};
	}

	window.setBidPrice = function(bidListHistory, hallType, hallCount) { //根据竞价数量变更竞价金额
		var alreadyGetNum = 0, //竞价领先数量
			bidNumber = $('.bidNumber'),
			bidAmount = $('.bidAmount'),
			cjPrice = $('.cjPrice'),
			inputNum = $('.bidNumber').val(),
			priceNum = $('.bidAmount').val(),
			totalNum = parseFloat(hallCount), //总量
			count = 0, //遍历次数
			remainingNum, //剩余数量
			priceShow; //显示价格
		if (bidListHistory) {
			$.each(bidListHistory, function(i, o) {
				if (o.flag == 1 || o.flag == 2) {
					alreadyGetNum = alreadyGetNum + Number(o.count);
					remainingNum = totalNum - alreadyGetNum;
					$('.bidAmount').val(o.price).attr('min', o.price);
					if (remainingNum == inputNum && i < bidListHistory.length - 1) { //剩余量恰好充足
						if (hallType == 'wxcg' || hallType == 'fscg' || hallType == 'tjcg' || hallType == 'shcg' || hallType == 'cdcg' || hallType == 'bjcg') { //采购厅
							priceShow = Number(bidListHistory[i + 1].price) + 10; //在下一个基础上加10元
							if (priceShow > 100000) {
								priceShow = 100000;
							}
							$('.bidAmount').val(priceShow).attr('min', priceShow);
							if (o.premium_market == 1) {
								if (priceShow > 0) {
									cjPrice.text('长江价+' + priceShow);
								} else if (priceShow < 0) {
									cjPrice.text('长江价' + priceShow);
								} else if (priceShow == 0) {
									cjPrice.text('长江价');
								}
							}
						} else if (hallType == 'wxxs' || hallType == 'fsxs' || hallType == 'shxs' || hallType == 'tjxs' || hallType == 'cdxs') { //销售厅
							priceShow = Number(bidListHistory[i + 1].price) - 10; //在下一个基础减加10元
							$('.bidAmount').val(priceShow).attr('max', priceShow);
						}
						return false;
					} else if (remainingNum < inputNum) { //剩余量不足
						if (hallType == 'wxcg' || hallType == 'fscg' || hallType == 'tjcg' || hallType == 'shcg' || hallType == 'cdcg' || hallType == 'bjcg') { //采购厅
							priceShow = Number(bidListHistory[i].price) + 10; //在当前基础上加10元
							if (priceShow > 100000) {
								priceShow = 100000;
							}
							$('.bidAmount').val(priceShow).attr('min', priceShow);
							if (o.premium_market == 1) {
								if (priceShow > 0) {
									cjPrice.text('长江价+' + priceShow);
								} else if (priceShow < 0) {
									cjPrice.text('长江价' + priceShow);
								} else if (priceShow == 0) {
									cjPrice.text('长江价');
								}
							}
						} else if (hallType == 'wxxs' || hallType == 'fsxs' || hallType == 'shxs' || hallType == 'tjxs' || hallType == 'cdxs') { //销售厅
							priceShow = Number(bidListHistory[i].price) - 10; //在当前基础减加10元
							$('.bidAmount').val(priceShow).attr('max', priceShow);
						}
						return false;
					} else if (remainingNum > inputNum) {
						priceShow = Number(o.price);
						if (priceShow > 100000) {
							priceShow = 100000;
						}
						$('.bidAmount').val(priceShow).attr('min', priceShow);
						if (o.premium_market == 1) {
							if (priceShow > 0) {
								cjPrice.text('长江价+' + priceShow);
							} else if (priceShow < 0) {
								cjPrice.text('长江价' + priceShow);
							} else if (priceShow == 0) {
								cjPrice.text('长江价');
							}
						}
					} else {
						count++;
					}
				}
			});

		} else if (!bidListHistory) { //剩余量充足
			$('.bidAmount').val(parseFloat(window.product.price));
			if (hallType == 'wxcg' || hallType == 'fscg' || hallType == 'tjcg' || hallType == 'shcg' || hallType == 'cdcg' || hallType == 'bjcg') { //采购厅最低价最高价
				$('.bidAmount').attr('max', '100000');
				$('.bidAmount').attr('min', parseFloat(window.product.price));
			} else if (hallType == 'wxxs' || hallType == 'fsxs' || hallType == 'shxs' || hallType == 'tjxs' || hallType == 'cdxs') { //销售厅最低价最高价
				$('.bidAmount').attr('max', parseFloat(window.product.price));
				$('.bidAmount').attr('min', '1000');
			}
		}
	};
	window.chat = {
		/**
		 * WebSocket实现语音聊天室
		 * @function
		 *            @example
		 *                chat.connect();
		 */
		ws: {},
		chatListArr: [],
		user: {},
		userList: [],
		cmd: '',
		curId: '',
		bidListHistory: [],
		delay: null,
		creatNewConnect: null,
		isKeepAlive: true, // 是否正常连接
		isConnect: 0,
		isCloseConnect: 0, // 主动关闭连接
		connect: function(option) { // 创建聊天连接或进入竞价厅，始终保持一个链接来使用
			if (chat.ws.readyState != 1) { // 未连接
				clearInterval(chat.delay);
				chat.delay = setInterval(function() {
					if (chat.ws.readyState != 2 && chat.ws.readyState != 1 && chat.ws.readyState != 0) {
						clearInterval(chat.delay);
						console.log('new chat ws', chat.ws.readyState, +new Date());
						if (window.WebSocket || window.MozWebSocket) { //使用原生WebSocket
							chat.ws = new WebSocket(webim.server); //创建WebSocket对象
							chat.isKeepAlive = true;
							chat.listenEvent(option);
						} else { //使用http xhr长轮循
							window.WEB_SOCKET_SWF_LOCATION = "http://www.lvdaniu.com/WebSocketMain.swf";
							$.getScript("http://static.lvdaniu.net/ux/js/utils/swfobject.js", function() {
								$.getScript("http://static.lvdaniu.net/ux/js/utils/web_socket.js", function() {
									console.log('flash');
									chat.ws = new WebSocket(webim.server);
									chat.isKeepAlive = true;
									chat.listenEvent(option);
								});
							});
							//chat.ws = new Comet(webim.server);
							//chat.listenEvent(option);
						}
						//chat.listenEvent(option);
					}
				}, 100);
			} else { // 已连接
				if (window.hall.name) { // 进入竞价厅
					var msg = {
						cmd: 'enterAuctionHall',
						userkey: option.userkey,
						mobile: option.mobile
					};
					chat.ws.send(JSON.stringify(msg));
					chat.isEnterBidHall = 1;
				} else { // 重新登录，切换帐号
					var msg = { //发送登录信息
						cmd: 'online', //登录态
						userkey: option.userkey,
						mobile: option.mobile //用手机号来标记用户
					};
					window.xhrStartTime = +new Date();
					chat.ws.send(JSON.stringify(msg));
				}
			}
		},
		listenEvent: function(option) {
			chat.ws.onopen = function(e) { //成功建立连接
				chat.isConnect = 1;
				var msg = { //发送登录信息
					cmd: 'online', //登录态
					userkey: option.userkey,
					mobile: option.mobile //用手机号来标记用户
				};
				window.xhrStartTime = +new Date();
				chat.ws.send(JSON.stringify(msg)); //向服务器发送消息
				console.log("服务器连接成功", +new Date());
			};
			chat.ws.onmessage = function(e) { //收到服务器消息，使用e.data提取
				var message = JSON.parse(e.data),
					cmd = message.cmd;
				window.cmd = cmd;
				//console.log(message);
				if (message.user) {
					chat.user = message.user;
				}
				console.log(cmd, message.time);
				//console.log(message.time);
				if (cmd == 'online') {
					if (window.location.pathname == '/auction/index') { //非初次连接
						chat.ws.send(JSON.stringify({
							cmd: 'enterAuctionHall',
							hall: option.hall,
							userkey: option.userkey
						}));
						chat.isEnterBidHall = 1;
					}
					if (message.time && window.getNowTime) {
						window.xhrEndTime = +new Date();
						window.getNowTime(message);
					}
					//console.log(message.time, 'get time from online');
				} else if (cmd == 'enterAuctionHall') {
					chat.ws.send(JSON.stringify({
						cmd: 'getChatHistory',
						userkey: option.userkey
					}));
					chat.ws.send(JSON.stringify({
						cmd: 'getAuctionHallUsers',
						userkey: option.userkey
					}));
					chat.ws.send(JSON.stringify({
						cmd: 'getBidHistory',
						userkey: option.userkey
					}));
					if (message.time && window.getNowTime) {
						window.getNowTime(message);
					}
					console.log(message.time, 'get time from enterAuctionHall');
				} else if (cmd == 'getAuctionHallUsers') { //获取在线列表
					chat.showOnlineList(message);
				} else if (cmd == 'getChatHistory') { //获取历史记录
					chat.showHistory(message);
				} else if (cmd == 'getBidHistory') { //获取竞价列表
					chat.showBidList(message);
				} else if (cmd == 'bidMessage' || cmd == 'chatMessage') { //获取竞价/聊天消息
					chat.showNewMsg(message);
				} else if (cmd == 'userEnterAuctionHall') { //有用户上线
					chat.showOnlineMsg(message);
					chat.showOnlineList(message);
				} else if (cmd == 'userQuitAuctionHall') { //有用户下线
					chat.showOfflineMsg(message);
				} else if (cmd == 'auctionFinish') { //竞价结束获取历史列表
					window.mark = 'isEnd';
					chat.getFinishMsg(message);
					chat.sendSystemInfo(message);
					chat.showTimeLine(message);
					if (message.time && window.getNowTime) {
						window.getNowTime(message);
					}
				} else if (cmd == 'error') {
					chat.getErrorMsg(message)
				} else if (cmd == 'keepAlive') {
					// window.now = message.time;
					chat.ws.send(JSON.stringify({
						cmd: 'keepAlive',
						userkey: option.userkey
					}));
				} else if (cmd == 'keepAliveFront') {
					chat.keepAliveFront(message);

				} else if (cmd == 'auctionRelease' || cmd == 'auctionDelete') { // 更新时间轴
					chat.showTimeLine(message);
					if (message.time && window.getNowTime) {
						window.getNowTime(message);
					}
				} else if (cmd == 'auctionStart') { // 竞价开始
					window.mark = 'isStart';
					chat.showTimeLine(message);
					chat.sendSystemInfo(message);
					$('.bidRecord .active').text('0')
					if (message.time && window.getNowTime) {
						window.getNowTime(message);
					}
				} else if (cmd == 'auctionPrepareStart') { // 竞价开始前5分钟
					chat.showTimeLine(message);
					chat.sendSystemInfo(message);
				} else if (cmd == 'squeezedOut') { // 出局
					chat.bidOut(message);
					window.player('http://static.lvdaniu.net/mx/img/ldn/bid_out.mp3');
				}
			};

			chat.ws.onclose = function(e) { //连接关闭
				console.log('聊天服务器已关闭', +new Date());
				chat.isConnect = 0;
			};

			chat.ws.onerror = function(e) { //连接异常
				// alert("服务器[" + webim.server + "]: 拒绝了连接. 请检查服务器是否启动. ");
				console.log("onerror: " + e, chat.ws.readyState);
				chat.isConnect = 0;
			};
		},
		bidOut: function(data) { //竞价出局提示
			UX.alert('您的出价已被超越，请您增加出价金额或者减少采购数量');
		},
		showTimeLine: function(data) { // 更新时间轴
			var cmd = data.cmd;
			if (cmd == 'auctionStart') {
				window.auctionBatch = data.auctionBatch;
			}
			$.ajax({
				url: '/auction/sync-get-auction-time-line',
				unCancel: true,
				data: {
					hall: hall.name
				},
				type: 'post',
				success: function(data) {
					var data = UX.json(data);
					// window.now = data.time;
					if (data.resultCode == 0) {
						var currentProduct = data.data.cur_auc;
						window.nextProduct = data.data.next_auc;
						var currentBidList = data.data.bid_list;
						var ishaveBid = 0;
						var manyBid = 0;
						var li = 0;
						window.haveStart = 0;
						UX.each(data.data.auc_list, function(o, i) {
							li++;
							if (o.status == 2) {
								ishaveBid = 1;
								window.haveStart = 1;
							}
						});
						UX.each(data.data.bid_list, function(o, i) {
							if (o.keep_ahead == "Y") {
								manyBid = Number(manyBid) + Number(o.amount);
							}
						});
						var showManyBid = parseFloat(currentProduct.amount_setted) - manyBid;
						if (currentProduct.status != 3) {
							$('.bidEndIcon').hide();
						} else if (currentProduct.status == 3) {
							$('.bidEndIcon').show();
						}
						if (ishaveBid) {
							window.product = {
								price: currentProduct.start_price,
								count: currentProduct.amount_setted,
								price_step: currentProduct.price_incr_step,
								count_step: currentProduct.amount_incr_step,
								premium_market: currentProduct.premium_market,
								start_time: currentProduct.start_time,
								end_time: currentProduct.end_time
							};
						} else {
							if (nextProduct) {
								window.product = {
									price: nextProduct.start_price,
									count: nextProduct.amount_setted,
									price_step: nextProduct.price_incr_step,
									count_step: nextProduct.amount_incr_step,
									premium_market: nextProduct.premium_market,
									start_time: nextProduct.start_time,
									end_time: nextProduct.end_time
								};
							}
						}
						if (cmd == 'auctionStart') {
							if (data.data.cur_auc.premium_market == 1) {
								$('.cjPrice').show();
								$('.bidAmount').val(parseFloat(window.product.price)).attr('min', parseFloat(window.product.price)).attr('data-step', window.product.price_step);
								if (data.data.cur_auc.start_price < 0) {
									$('.cjPrice').text('长江价' + parseFloat(window.product.price));
								} else if (data.data.cur_auc.start_price > 0) {
									$('.cjPrice').text('长江价+' + parseFloat(window.product.price));
								} else if (data.data.cur_auc.start_price == 0) {
									$('.cjPrice').text('长江价');
								}
							} else if (data.data.cur_auc.premium_market == 0) {
								$('.cjPrice').hide()
								$('.bidAmount').val(parseFloat(window.product.price)).attr('min', parseFloat(window.product.price)).attr('data-step', window.product.price_step);
							}
							$('.bidNumber').val(window.product.count_step).attr('max', parseFloat(window.product.count)).attr('min', parseFloat(window.product.count_step)).attr('data-step', product.count_step);
							addReduce.init();
						}
						var timeLineTemp = UX.txTpl('<%UX.each(timeline,function(o,i){%>\
							<li class="<%if(o.status == 2){%>competitioning <%if(o.id == current.id){%>currentStart<%}}%> <%if(o.status == 1){%>ending <%if(o.id == current.id){%>currentWill<%}}%> <%if(o.status == 3){%>ended <%if(o.id == current.id){%>currentEnd<%}}%> timeLine">\
							<div class="time"><%=UX.formatDate(new Date((o.start_time) * 1000),"yyyy-MM-dd hh:mm:ss")%></div>\
							<div class="clickArea"></div>\
							<div class="line" auction_id = "<%=o.id%>"></div>\
							<%if(o.status == 2){%><span>正在竞价</span><%}%>\
							<%if(o.status == 3){%><span>竞价结束</span><%}%>\
							<%if(o.status == 1){%><span>即将竞价</span><%}%>\
							<%if(o.status == 2 || o.status == 3){%><span><%=o.productInfo.category%> <%=o.productInfo.brand%> <%=o.productInfo.spec%></span><%}%>\
							</li>\
						<%});%>', {
							timeline: data.data.auc_list,
							current: currentProduct
						});
						var productInfoTemp = UX.txTpl('<li>品类： <%=productInfo.productInfo.category%></li>\
										<li>产品品牌： <%=productInfo.productInfo.brand%></li>\
										<li>规格型号： <%=productInfo.productInfo.spec%></li>\
										<%if(productInfo.premium_market == 1){%><%if(productInfo.start_price != 0){%><li>基准价格： <span class="active basePrice"><%if(productInfo.start_price > 0){%>长江价+<%}else if(productInfo.start_price < 0){%>长江价<%}%><%=parseFloat(productInfo.start_price)%></span>元/吨</li><%}%>\
										<%if(productInfo.start_price == 0){%><li>基准价格： <span class="active basePrice">长江价</span></li><%}}%>\
										<%if(productInfo.premium_market == 0){%><li>基准价格： <span class="active basePrice"><%=parseFloat(productInfo.start_price)%></span>元/吨</li><%}%>\
										<li>竞价批次： <%=productInfo.auction_batch%></li>\
										<li>价格增幅： <%=parseFloat(productInfo.price_incr_step)%>元</li>\
										<li>竞价时长： <%= productInfo.duration%>分钟</li>\
										<li>数量增幅： <%= parseFloat(productInfo.amount_incr_step)%>吨</li>\
										<li>竞价总量： <span class="bidCount"><%=parseFloat(productInfo.amount_setted)%></span>吨</li>\
										<li>结算方式： <%if(productInfo.settle_way == 1){%>现款现货<%}%><%if(productInfo.settle_way == 2){%>锁价模式<%}%> <%if(productInfo.settle_way == 3){%>现款现货或锁价模式<%}%></li>\
										<%if(productInfo.summary){%><li>备注： <%=productInfo.summary%></li><%}%>', {
							productInfo: currentProduct
						});
						var bidListTemp = UX.txTpl('<table class="tac bidHistory-list">\
												<thead>\
													<th>#</th>\
													<th class="company"><span class="bid">竞价者</span></th>\
													<th>出价/元</th>\
													<th>数量/吨</th>\
													<th class="bid_time">出价时间</th>\
												</thead>\
												<tbody>\
									<%UX.each(bidList,function(o,i){%>\
										<tr <%if(o.keep_ahead == "Y" || o.keep_ahead == "P"){%>class="active"<%}%>>\
											<td><%=i+1%></td>\
											<td class="companyname"><span class="name <%if(o.keep_ahead == "P"){%>nameMany<%}%>" title="<%=o.com_name%>"><%=o.com_name%></span><%if(o.keep_ahead == "Y" || o.keep_ahead == "P"){%><span class="get"><%if(cmd != "auctionStart" && window.mark == "isEnd"){%>中标<%}else{%>领先<%}%></span><%}%></td>\
											<%if(o.premium_market == 1){%><%if(o.price != 0){%><td><%if(o.price < 0){%>长江价<%}else if(o.price > 0){%>长江价+<%}%><%=o.price%></td><%}%>\
											<%if(o.price == 0){%><td>长江价</td><%}}%>\
											<%if(o.premium_market == 0){%><td><%=o.price%></td><%}%>\
											<%if(o.keep_ahead != "P"){%><td><%=o.amount%></td><%}%>\
											<%if(o.keep_ahead == "P"){%><td><%=showManyBid%><span class="amountbid">/<%=o.amount%></span></td><%}%>\
											<td class="time"><%=UX.formatDate(new Date((o.create_time) * 1000),"hh:mm:ss")%></td>\
										</tr>\
									<%})%>\
									</tbody>\
									</table>', {
							bidList: currentBidList,
							showManyBid: showManyBid,
							cmd: cmd
						});
						$('.time-list .progress').html(timeLineTemp);
						$('.progress li').width(950 / li);
						$('.progress li .clickArea').width(950 / li);
						//if(cmd == 'auctionStart'){
						if (currentBidList.length) {
							$('.chujias .bid-list-show').html(bidListTemp);
						} else {
							if (cmd == 'auctionStart') {
								$('.chujias .bid-list-show').html('<div class="nullInfo">暂时无人出价，就等您出价啦</div>');
							} else if (cmd == 'auctionFinish') {
								$('.chujias .bid-list-show').html('<div class="nullInfo">无人出价，产品已流拍</div>');
							}
						}
						$('.productInfo-list').html(productInfoTemp);
						//}
						if (cmd == 'auctionFinish') {
							$('.bidPrice').hide();
							$('.bidAmount').val('').attr('min', '').attr('data-step', '');
							$('.chujias table tbody').css('height', '225px');
						}
					}
				}
			});
		},
		keepAliveFront: function(data) { //前台连接心跳
			if (data.time) {
				// Page.data.now = data.time;
				// console.log('keep alive...', data.time);
				window.xhrEndTime = +new Date();
				window.getNowTime(data, true);
			}
			chat.isKeepAlive = true;
		},
		sendAlive: function(isFront) { //发送心跳
			var msg = {
				cmd: isFront ? 'keepAliveFront' : 'keepAlive', //登录态
				userkey: config.client.userkey
			};
			if (isFront) {
				// chat.isKeepAlive = false;
				if (chat.isKeepAlive && !chat.isCloseConnect) {
					chat.isKeepAlive = false;
					window.xhrStartTime = +new Date();
					chat.ws.send(JSON.stringify(msg));
				} else { // 连接失效，销毁现有连接
					chat.ws.onopen = null;
					chat.ws.onmessage = null;
					chat.ws.onclose = null;
					chat.ws.onerror = null;
					chat.closeConnect(true); // 不大确定，是不是这个导致ws又被恢复了，导致ws还在，isConnect却是0
					chat.isConnect = 0;
					chat.ws = {
						close: function() {

						},
						send: function() {

						},
						readyState: 3
					};
				}
			} else {
				window.xhrStartTime = +new Date();
				chat.ws.send(JSON.stringify(msg));
			}
		},
		showBidList: function(data) { //显示竞价列表
			var manyBid = 0;
			if (data.historyList) {
				var bidListHistory = data.historyList;
				window.bidListHistory = data.historyList || [];
				$('.bidRecord .active').text(bidListHistory.length);
				setBidPrice(bidListHistory, hall.name, window.product.count);
				UX.each(bidListHistory, function(o, i) {
					//console.log(o.flag);
					if (o.flag == 1) {
						manyBid = Number(manyBid) + Number(o.count);
					}
				});
				var showManyBid = product.count - manyBid;
				var bidListTemp = UX.txTpl('<table class="tac bidHistory-list">\
									<thead>\
										<th>#</th>\
										<th class="company"><span class="bid">竞价者</span></th>\
										<th>出价/元</th>\
										<th>数量/吨</th>\
										<th class="bid_time">出价时间</th>\
									</thead>\
									<tbody>\
							<%UX.each(bidListHistory,function(o,i){if(bidListHistory.length){%>\
                                     <tr <%if(o.flag == 1 || o.flag == 2){%>class="active"<%}%>>\
                                        <td><%=i+1%></td>\
                                        <td class="companyname"><span class="name <%if(o.flag == 2){%>nameMany<%}%>" title="<%=o.com_name%>"><%=o.com_name%></span><%if(o.flag == 1 || o.flag == 2){%><span class="get">领先</span><%}%></td>\
                                        <%if(o.premium_market == 1){%><%if(o.price != 0){%><td><%if(o.price < 0){%>长江价<%}else if(o.price > 0){%>长江价+<%}%><%=o.price%></td><%}%>\
										<%if(o.price == 0){%><td>长江价</td><%}}%>\
										<%if(o.premium_market == 0){%><td><%=o.price%></td><%}%>\
										<%if(!o.premium_market){%><td><%=o.price%></td><%}%>\
                                        <%if(o.flag != 2){%><td><%=o.count%></td><%}%>\
										 <%if(o.flag == 2){%><td><%=showManyBid%><span class="amountbid">/<%=o.count%></span></td><%}%>\
                                        <td><%=o.create_time%></td>\
                                    </tr>\
                                <%}}) %>\
								</tbody>\
								</table>', {
					bidListHistory: bidListHistory,
					showManyBid: showManyBid
				});
				if (window.mark == 'isStart') {
					$('.chujias .bid-list-show').html(bidListTemp);
				}
			} else { //无竞价信息
				if (window.haveStart == 1) {
					$('.bidAmount').val(parseFloat(window.product.price)).attr('min', window.product.price);
					if (window.product.premium_market == 1) {
						var priceShow = parseFloat($('.bidAmount').val());
						if (priceShow > 0) {
							$('.cjPrice').text('长江价+' + priceShow);
						} else if (priceShow < 0) {
							$('.cjPrice').text('长江价' + priceShow);
						} else if (priceShow == 0) {
							$('.cjPrice').text('长江价');
						}
					}
				}
			}

		},
		showOnlineList: function(data) { //显示用户在线列表
			console.log(data, '上线');
			chat.userList = data.userList;
			/*if(data.cmd == 'getAuctionHallUsers'){
				chat.userList = data.userList;
			}
			if(data.cmd == 'userEnterAuctionHall'){
				if(data.user.mobile != config.client.mobile){
					chat.userList.push(data.user);
				}
			}*/
			var userListTemp = UX.txTpl('<div class="title">在线列表(<%=userList.length%>)<div class="floatR btnClose">关闭</div></div>\
											<div class="userInfoDiv">\
				<%UX.each(userList,function(i,o){%>\
						<div class="userInfo">\
							<div class="touxiang" style="background-image:url(<%=i.avatar%>);"></div><div class="companyInfo"><%=i.realname%> - <%=i.corporation%></div>\
						</div>\
			<%})%></div>', {
				userList: chat.userList
			});
			$(".online-list").html(userListTemp);
		},
		showOnlineMsg: function(data) { //用户上线
			//console.log(data,'online');		
		},
		close: function() { //关闭websocket连接
			chat.ws.close();
		},
		closeConnect: function(isClose) { //关闭聊天
			clearInterval(chat.delay);
			if(isClose){
				chat.ws.close();
			}
			clearInterval(chat.creatNewConnect);
		},
		showOfflineMsg: function(data) { //用户下线
			console.log('用户下线');
			if(data.userList){
				chat.userList = data.userList;
			}else if (chat.userList) {
                 $.each(chat.userList, function(i, o) {
					if(o){
						if (o.mobile == data.mobile && o) {
							chat.userList.splice(i, 1);
						}
                    }
                });
            }
			var userListTemp = UX.txTpl('<div class="title">在线列表(<%=userList.length%>)<div class="floatR btnClose">关闭</div></div>\
											<div class="userInfoDiv">\
				<%UX.each(userList,function(i,o){%>\
						<div class="userInfo">\
							<div class="touxiang" style="background-image:url(<%=i.avatar%>);"></div><div class="companyInfo"><%=i.realname%> - <%=i.corporation%></div>\
						</div>\
			<%})%></div>',{
				userList:chat.userList
			});
			$(".online-list").html(userListTemp);

		},
		showHistory: function(data) { //显示历史列表
			var cmd = chat.cmd;
			window.curId = data.curId;
			var chatList = data.historyList;
			window.chat.chatListArr = chatList;
			window.chatListLength = chatList.length;
			if (chatList && chatList.length) {
				var baseTime = chatList[0].time;
				$.each(chatList, function(i, o) { //时间显示
					if (i == 0) {
						var loadId = Number(o.id);
						window.loadId = loadId.toString();
					}
					var timeGap = o.time - baseTime;
					o.formatTime = UX.formatDate(new Date((o.time) * 1000), 'yyyy-MM-dd hh:mm');
					if ((timeGap / 60) > 5) { //间隔时间超过五分钟
						o.timeShow = 1;
						if (i < chatList.length - 1) {
							baseTime = chatList[i + 1].time;
							chatList[i + 1].timeShow = 1; //起始记录显示时间
						}
					} else {
						if ((timeGap / 60) > 2) {
							o.timeShow = 1;
							if (i < chatList.length - 1) {
								baseTime = chatList[i + 1].time;
								chatList[i + 1].timeShow = 1; //起始记录显示时间
							}
						} else {
							o.timeShow = 0;
						}
					}
				});
				chatList[0].timeShow = 1; //第一条显示时间
			}
			if (data.historyList) {
				var userInfo = data.historyList.user;
				var newMsgTemp = UX.txTpl('<%UX.each(chatList,function(i,o){%>\
						<%if(!i.user){%>\
							<div class="timeline bidTip loadMark" data-id ="<%=i.id%>">\
								<div class="bidRemind"></div>\
								<%if(i.cmd == "auctionStart"){%><div class="remindInfo" auction_id ="<%=i.auctionId%>">系统消息：批次<span class="active"><%=i.auctionBatch%></span>已经开始竞价</div><%}%>\
								<%if(i.cmd == "auctionPrepareStart"){%><div class="remindInfo" auction_id ="<%=i.auctionId%>">系统消息：批次<span class="active"><%=i.auctionBatch%></span>即将开始竞价</div><%}%>\
								<%if(i.cmd == "auctionFinish"){%><div class="remindInfo" auction_id ="<%=i.auctionId%>">系统消息：批次<span class="active"><%=i.auctionBatch%></span>竞价结束</div><%}%>\
						</div><%}%>\
						<%if(i.user){%>\
						<%if(i.user.id == config.client.id){%>\
						<%if(i.timeShow == 1){%><div class="timeline"><%=i.formatTime%></div><%}%>\
						<div class=" jj-chat-list jj-chat-list-right loadMark" data-id ="<%=i.id%>">\
							<div class="jj-chat-avatar">\
								<div class="img" style="background-image:url(<%=i.user.avatar%>);"></div>\
							</div>\
							<div class="jj-chat-infos">\
								<div class="jj-chat-name"></div>\
								<%if(i.cmd == "bidMessage"){%>\
								<div class="success">\
									<i class="triangle"></i>\
									<div class="detail">\
										<span class="bid-num">批次号：<%=i.auctionBatch%></span>\
										<span class="bid-img"></span>\
										<%if(i.msg.premium_market == 1){%><%if(i.msg.price != 0){%><span class="price"><%if(i.msg.price > 0){%>长江价+<%}else if(i.msg.price < 0){%>长江价<%}%><%=i.msg.price%>元/吨</span><%}%>\
										<%if(i.msg.price == 0){%><span class="price">长江价 元/吨</span><%}}%>\
										<%if(i.msg.premium_market == 0){%><span class="price"><%=i.msg.price%>元/吨</span><%}%>\
										<%if(!i.msg.premium_market){%><span class="price"><%=i.msg.price%>元/吨</span><%}%>\
										<span class="num"><%=i.msg.count%>吨</span>\
									</div>\
									<span class="status">出价成功</span>\
								</div><%}%>\
								<%if(i.cmd == "chatMessage"){%>\
								<div class="jj-chat-info message">\
									<i class="triangle"></i><%=i.msg%>\
								</div><%}%>\
							</div>\
						</div><%}%>\
						<%if(i.user.id != config.client.id){%>\
						<%if(i.timeShow == 1){%><div class="timeline"><%=i.formatTime%></div><%}%>\
						<div class="jj-chat-list jj-chat-list-left loadMark" data-id ="<%=i.id%>">\
							<div class="jj-chat-avatar">\
								<div class="img" style="background-image:url(<%=i.user.avatar%>);"></div>\
							</div>\
							<div class="jj-chat-infos">\
								<div class="jj-chat-name"><%=i.user.realname%></div>\
								<%if(i.cmd == "bidMessage"){%>\
								<div class="success">\
									<i class="triangle"></i>\
									<div class="detail">\
										<span class="bid-num">批次号：<%=i.auctionBatch%></span>\
										<span class="bid-img"></span>\
										<%if(i.msg.premium_market == 1){%><%if(i.msg.price != 0){%><span class="price"><%if(i.msg.price > 0){%>长江价+<%}else if(i.msg.price < 0){%>长江价<%}%><%=i.msg.price%>元/吨</span><%}%>\
										<%if(i.msg.price == 0){%><span class="price">长江价 元/吨</span><%}}%>\
										<%if(i.msg.premium_market == 0){%><span class="price"><%=i.msg.price%>元/吨</span><%}%>\
										<%if(!i.msg.premium_market){%><span class="price"><%=i.msg.price%>元/吨</span><%}%>\
										<span class="num"><%=i.msg.count%>吨</span>\
									</div>\
									<span class="status">出价成功</span>\
								</div><%}%>\
								<%if(i.cmd == "chatMessage"){%>\
								<div class="jj-chat-info message">\
									<i class="triangle"></i><%=i.msg%>\
								</div><%}%>\
							</div>\
						</div><%}}})%>', {
					chatList: data.historyList,
					userInfo: userInfo,
					config: config
				});
				if (window.loadHistory == 0) {
					$(".msgShow").html(newMsgTemp);
				} else {
					var timer;
					//$("[data-id="+window.loadId +"]").prepend(newMsgTemp);
					$(newMsgTemp).insertBefore($("[data-id=" + chat.curId + "]"));
					if (chatList.length > 0) {
						$('.msgShow').scrollTop(1000);
					} else if (chatList.length < 30) {
						clearTimeout(timer);
						$('.messageTip').text('没有更多消息了！').show();
						timer = setTimeout(function() {
							$('.messageTip').hide();
						}, 2000);
					}
				}
				chat.curId = window.curId;
			}
			if (window.loadHistory == 0) {
				setTimeout(function() { //滚动到底部
					var gap = $('.msgShow').find('.jj-chat-list').height() + 99900;
					$('.msgShow').scrollTop(gap);
				}, 100);
			}
		},
		getFinishMsg: function(data) {
			// if (data.bidListMsg) {
			//     var dataList = JSON.parse(data.bidListMsg);
			//     Page.data.bidListHistory = dataList.data || {};
			// }
		},
		getErrorMsg: function(data) {
			console.log(data.code);
			if (data.code == 101) { //登录态判定 用户信息不存在，重新登录
				chat.closeConnect(true);
				chat.isCloseConnect = 1;
				clearTimeout(window.setTimeoutIndex);
				UX.alert('您已掉线，请重新登录！', function() {
					window.location.href = "http://www.lvdaniu.com?stay=1";
				});
				//window.location.href = "http://www.lvdaniu.com";
				window.setTimeoutIndex = setTimeout(function() {
					window.location.href = "http://www.lvdaniu.com?stay=1";
				}, 10000)
			} else if (data.code == 102 || data.code == 104) { //102字数超限 104频繁发送
				UX.alert(data.msg);
			} else if (data.code == -1000) {
				UX.alert(data.msg);
			} else if (data.code == 110) {
				chat.closeConnect(true);
				chat.isCloseConnect = 1;
				UX.alert('您的账户已重新认证，请耐心等待审核。', function() {
					window.location.href = "http://www.lvdaniu.com?stay=1";
				});
			} else if (data.code == 105) {
				chat.closeConnect(true);
				chat.isCloseConnect = 1;
				UX.alert('该用户账号重复登陆！', function() {
					window.location.href = "http://www.lvdaniu.com?stay=1";
				});
			}
		},
		quit: function() { // 退出登录
			if (chat.ws.readyState == 1) {
				var msg = {
					cmd: 'logoutAuctionHall',
					userkey: config.client.userkey,
					uid: config.client.mobile
				};
				chat.ws.send(JSON.stringify(msg));
			}
		},
		quitHall: function() { // 退出竞价大厅
			if (chat.isEnterBidHall) {
				var msg = {
					cmd: 'quitAuctionHall',
					userkey: config.client.userkey,
					uid: config.client.mobile
				};
				chat.ws.send(JSON.stringify(msg));
				chat.isEnterBidHall = 0;
			}
		},
		sendSystemInfo: function(data) {
			var batchInfo = data.auctionBatch;
			var cmd = data.cmd;
			$.ajax({
				url: '/notice/noticecnt',
				unCancel: true,
				data: {
					userkey: config.client.userkey
				},
				type: 'post',
				success: function(data) {
					var data = UX.json(data);
					// window.now = data.time;
					if (data.resultCode == 0) {
						if (data.data.unReadTotalCnt > 0) {
							$('.message-box .msgNum').css('display', 'inline-block');
						} else if (data.data.unReadTotalCnt == 0) {
							$('.message-box .msgNum').hide();
						}
						$('.message-box .msgNum').text(data.data.unReadTotalCnt);
						$('.message-box .bidMsg').text(data.data.unReadTradeCnt);
						$('.message-box .purMsg').text(data.data.unReadPurchCnt);
					}
				}
			});
			var newMsgTemp = UX.txTpl('<div class="timeline bidTip">\
								<div class="bidRemind"></div>\
								<%if(cmd == "auctionStart"){%><div class="remindInfo">系统消息：批次<span class="active"><%=batchInfo%></span>已经开始竞价</div><%}%>\
								<%if(cmd == "auctionPrepareStart"){%><div class="remindInfo">系统消息：批次<span class="active"><%=batchInfo%></span>即将开始竞价</div><%}%>\
								<%if(cmd == "auctionFinish"){%><div class="remindInfo">系统消息：批次<span class="active"><%=batchInfo%></span>竞价结束</div><%}%>\
								</div>', {
				batchInfo: batchInfo,
				cmd: cmd
			});
			$(newMsgTemp).appendTo(".msgShow");
			if (window.loadHistory == 0) { //判断是否正在查看聊天历史记录
				setTimeout(function() { //滚动到底部
					//var gap = $('.msgShow').find('.jj-chat-list').height() + 99900;
					$('.msgShow').scrollTop(99999);
				}, 100);
			}
		},
		showNewMsg: function(data) { //新的推送信息

			//更新历史列表
			var chatLists = data;
			var userInfo = data.user;
			var cmd = data.cmd;
			var manyBid = 0;
			if (data.bidList) {
				var dataList = data.bidList;
				window.bidListHistory = dataList || {};
				setBidPrice(dataList, hall.name, product.count);
				$('.bidRecord .active').text(bidListHistory.length);
				UX.each(bidListHistory, function(o, i) {
					//console.log(o.flag);
					if (o.flag == 1) {
						manyBid = Number(manyBid) + Number(o.count);
					}
				});
				var showManyBid = product.count - manyBid;
				//console.log(manyBid,showManyBid);
				var bidListTemp = UX.txTpl('<table class="tac bidHistory-list">\
									<thead>\
										<th>#</th>\
										<th class="company"><span class="bid">竞价者</span></th>\
										<th>出价/元</th>\
										<th>数量/吨</th>\
										<th class="bid_time">出价时间</th>\
									</thead>\
									<tbody>\
							<%UX.each(bidListHistory,function(o,i){if(bidListHistory.length){%>\
                                     <tr <%if(o.flag == 1 || o.flag == 2){%>class="active"<%}%>>\
                                        <td><%=i+1%></td>\
                                        <td class="companyname" title="<%=o.com_name%>"><span class="name"><%=o.com_name%></span><%if(o.flag == 1 || o.flag == 2){%><span class="get">领先</span><%}%></td>\
                                        <%if(o.premium_market == 1){%><%if(o.price != 0){%><td><%if(o.price < 0){%>长江价<%}else if(o.price > 0){%>长江价+<%}%><%=o.price%></td><%}%>\
										<%if(o.price == 0){%><td>长江价</td><%}}%>\
										<%if(o.premium_market == 0){%><td><%=o.price%></td><%}%>\
                                        <%if(o.flag != 2){%><td><%=o.count%></td><%}%>\
										<%if(o.flag == 2){%><td><%=showManyBid%><span class="amountbid">/<%=o.count%></span></td><%}%>\
                                        <td><%=o.create_time%></td>\
                                    </tr>\
                                <%}}) %>\
								</tbody>\
								</table>', {
					bidListHistory: bidListHistory,
					showManyBid: showManyBid
				});
				if (window.mark == "isStart") {
					$('.chujias .bid-list-show').html(bidListTemp);
				}
			}
			data.formatTime = UX.formatDate(new Date((data.time) * 1000), 'yyyy-MM-dd hh:mm');
			if (chat.chatListArr && chat.chatListArr.length && (chat.chatListArr[chat.chatListArr.length - 1].cmd == 'chatMessage' || chat.chatListArr[chat.chatListArr.length - 1].cmd == 'bidMessage')) {
				var timeGap = data.time - chat.chatListArr[chat.chatListArr.length - 1].time;
				if ((timeGap / 60) > 5) { //间隔时间超过五分钟
					data.timeShow = 1;
				} else {
					if ((timeGap / 60) > 2) { //间隔时间超过两分钟
						data.timeShow = 1;
					} else { //间隔时间少于两分钟
						data.timeShow = 0;
					}
				}
				chat.chatListArr.push(data);
			} else {
				chat.chatListArr = [];
				data.timeShow = 1;
				chat.chatListArr.push(data);
			}
			var newMsgTemp = UX.txTpl('<%if(userInfo.id == config.client.id){%>\
						<%if(chatLists.timeShow == 1){%><div class="timeline"><%=chatLists.formatTime%></div><%}%>\
						<div class=" jj-chat-list jj-chat-list-right">\
							<div class="jj-chat-avatar">\
								<div class="img" style="background-image:url(<%=userInfo.avatar%>);"></div>\
							</div>\
							<div class="jj-chat-infos">\
								<div class="jj-chat-name"></div>\
								<%if(cmd == "bidMessage"){%>\
								<div class="success">\
									<i class="triangle"></i>\
									<div class="detail">\
										<span class="bid-num">批次号：<%=chatLists.auctionBatch%></span>\
										<span class="bid-img"></span>\
										<%if(chatLists.msg.premium_market == 1){%><%if(chatLists.msg.price != 0){%><span class="price"><%if(chatLists.msg.price > 0){%>长江价+<%}else if(chatLists.msg.price < 0){%>长江价<%}%><%=chatLists.msg.price%>元/吨</span><%}%>\
										<%if(chatLists.msg.price == 0){%><span class="price">长江价 元/吨</span><%}}%>\
										<%if(chatLists.msg.premium_market == 0){%><span class="price"><%=chatLists.msg.price%>元/吨</span><%}%>\
										<span class="num"><%=chatLists.msg.count%>吨</span>\
									</div>\
									<span class="status">出价成功</span>\
								</div><%}%>\
								<%if(cmd == "chatMessage"){%>\
								<div class="jj-chat-info message">\
									<i class="triangle"></i><%=chatLists.msg%>\
								</div><%}%>\
							</div>\
						</div><%}%>\
						<%if(userInfo.id != config.client.id){%>\
						<%if(chatList.timeShow == 1){%><div class="timeline"><%=chatLists.formatTime%></div><%}%>\
						<div class=" jj-chat-list jj-chat-list-left">\
							<div class="jj-chat-avatar">\
								<div class="img" style="background-image:url(<%=userInfo.avatar%>);"></div>\
							</div>\
							<div class="jj-chat-infos">\
								<div class="jj-chat-name"><%=userInfo.realname%></div>\
								<%if(cmd == "bidMessage"){%>\
								<div class="success">\
									<i class="triangle"></i>\
									<div class="detail">\
										<span class="bid-num">批次号：<%=chatLists.auctionBatch%></span>\
										<span class="bid-img"></span>\
										<%if(chatLists.msg.premium_market == 1){%><%if(chatLists.msg.price != 0){%><span class="price"><%if(chatLists.msg.price > 0){%>长江价+<%}else if(chatLists.msg.price < 0){%>长江价<%}%><%=chatLists.msg.price%>元/吨</span><%}%>\
										<%if(chatLists.msg.price == 0){%><span class="price">长江价 元/吨</span><%}}%>\
										<%if(chatLists.msg.premium_market == 0){%><span class="price"><%=chatLists.msg.price%>元/吨</span><%}%>\
										<span class="num"><%=chatLists.msg.count%>吨</span>\
									</div>\
									<span class="status">出价成功</span>\
								</div><%}%>\
								<%if(cmd == "chatMessage"){%>\
								<div class="jj-chat-info message">\
									<i class="triangle"></i><%=chatLists.msg%>\
								</div><%}%>\
							</div>\
						</div><%}%>', {
				chatLists: chatLists,
				userInfo: userInfo,
				cmd: cmd
			});
			$(newMsgTemp).appendTo(".msgShow");
			if (userInfo.mobile == config.client.mobile && cmd == 'bidMessage') {
				window.player("http://static.lvdaniu.net/mx/img/ldn/bid.mp3");
			}
			setTimeout(function() { //滚动到底部
				$('.msgShow').scrollTop(99999);
			}, 100);
		},
		sendMsg: function(content, type, cmd, callback) { //发送信息cmd: message聊天 cmd：bid竞价
			if (cmd == 'bidMessage') {
				var msg = {
					userkey: config.client.userkey,
					price: content.price,
					count: content.count,
					cmd: cmd,
					type: type,
					app: 1
				};
			} else if (cmd == 'chatMessage') {
				var msg = {
					userkey: config.client.userkey,
					data: content,
					cmd: cmd,
					type: type,
					app: 1
				};
			}

			if (!chat.ws || chat.ws.readyState != 1) {
				console.log('与聊天服务器已断开连接！');
				var time = 60;
				clearInterval(chat.creatNewConnect);
				chat.creatNewConnect = setInterval(function() {
					if (time) {
						chat.connect({ //建立聊天室连接
							mobile: config.client.mobile
						});
						if (chat.isConnect) {
							setTimeout(function() {
								if (chat.ws.readyState == 1) {
									chat.ws.send(JSON.stringify(msg));
									//callback && callback();
									clearInterval(chat.creatNewConnect);
								} else {
									time--;
								}
							}, 500);
						} else {
							time--;
						}
					} else {
						UX.alert('抱歉！连接出错，暂不能出价/发送信息。');
						clearInterval(chat.creatNewConnect);
					}
				}, 1000);
			} else {
				chat.ws.send(JSON.stringify(msg));
				//callback && callback();
			}
		}
	};
	return chat;
});